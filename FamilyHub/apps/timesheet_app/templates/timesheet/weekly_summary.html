{% if integrated_mode %}
    {% extends "base.html" %}
{% else %}
    {% extends 'timesheet/base.html' %}
{% endif %}

{% if integrated_mode %}
    {% block title %}Weekly Summary - Timesheet{% endblock %}
{% else %}
    {% block title %}Weekly Summary - Timesheet Standalone{% endblock %}
{% endif %}

{% if integrated_mode %}
    {% block app_navigation %}
        <!-- Tier 2 - App Navigation (CONTEXTUAL) -->
        <nav class="secondary-nav">
            <div class="container">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'timesheet:dashboard' %}">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'timesheet:daily_entry' %}">
                            <i class="fas fa-calendar-day me-1"></i>Daily Entry
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'timesheet:weekly_summary' %}">
                            <i class="fas fa-calendar-week me-1"></i>Weekly Summary
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'timesheet:job_list' %}">
                            <i class="fas fa-briefcase me-1"></i>Jobs
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    {% endblock %}

    {% block breadcrumb %}
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb" class="bg-light border-bottom">
            <div class="container">
                <ol class="breadcrumb mb-0 py-2">
                    <li class="breadcrumb-item">
                        <a href="/">üè† FamilyHub</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{% url 'timesheet:dashboard' %}">‚è∞ Timesheet</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">
                        üìä Weekly Summary
                    </li>
                </ol>
            </div>
        </nav>
    {% endblock %}
{% endif %}

{% block extra_css %}
<style>
    .day-card {
        min-height: 250px;
        display: flex;
        flex-direction: column;
    }
    .day-card .card-body {
        flex-grow: 1;
        overflow-y: auto;
        max-height: 200px;
    }
    
    /* Enhanced styling for weekdays vs weekends */
    .weekend-card {
        background-color: #f8f9fa;
        border: 2px solid #6c757d;
    }
    .weekday-card {
        background-color: #ffffff;
        border: 2px solid #0d6efd;
    }
    
    /* Fix border-radius mismatch between card border and header */
    .weekday-card .card-header:first-child,
    .weekend-card .card-header:first-child {
        border-radius: calc(var(--bs-card-inner-border-radius) - 2px) calc(var(--bs-card-inner-border-radius) - 2px) 0 0;
    }
    
    /* Fix for today's card with thicker border */
    .border-warning .card-header:first-child {
        border-radius: calc(var(--bs-card-inner-border-radius) - 3px) calc(var(--bs-card-inner-border-radius) - 3px) 0 0;
    }
    
    /* Better spacing for the two-row layout */
    .day-column {
        margin-bottom: 1rem;
        /* Removed border and border-radius that were causing double border effect */
    }
    
    /* Ensure equal height cards in each row */
    .row .day-column .day-card {
        height: 100%;
    }
    
    /* Section headers for weekdays/weekend */
    .row h5 {
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    /* Time entry styling within day cards */
    .time-entry {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .time-entry .job-name {
        font-weight: 600;
        color: #0d6efd;
    }
    
    .time-entry .time-details {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .time-entry .duration {
        font-weight: 600;
        color: #198754;
    }
    
    .no-entries {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 1rem;
    }
    
    /* Today's highlight */
    .today-highlight {
        border: 3px solid #ffc107 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
    }
    
    /* Weekly summary stats */
    .weekly-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
    }
    
    .stat-label {
        font-size: 0.875rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block title %}Weekly Summary - {{ week_start|date:"M j" }} to {{ week_end|date:"M j, Y" }}{% endblock %}

{% block content %}
{% show_template_path %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-calendar-week text-primary me-2"></i>
            Weekly Summary
        </h2>
        <div class="btn-group" role="group">
            <a href="{% url 'timesheet:weekly' %}?week={{ prev_week }}" class="btn btn-outline-primary">
                <i class="fas fa-chevron-left"></i> Previous Week
            </a>
            <a href="{% url 'timesheet:weekly' %}" class="btn btn-primary">
                <i class="fas fa-calendar-day"></i> Current Week
            </a>
            <a href="{% url 'timesheet:weekly' %}?week={{ next_week }}" class="btn btn-outline-primary">
                Next Week <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Week Date Range -->
    <div class="text-center mb-4">
        <h4 class="text-muted">
            {{ week_start|date:"F j" }} - {{ week_end|date:"F j, Y" }}
        </h4>
    </div>

    <!-- Weekly Statistics -->
    <div class="weekly-stats">
        <div class="row">
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <span class="stat-value">{{ total_hours|floatformat:1 }}</span>
                    <span class="stat-label">Total Hours</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <span class="stat-value">{{ days_worked }}</span>
                    <span class="stat-label">Days Worked</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <span class="stat-value">{{ total_entries }}</span>
                    <span class="stat-label">Time Entries</span>
                </div>
            </div>
            <div class="col-md-3 col-6">
                <div class="stat-item">
                    <span class="stat-value">${{ estimated_earnings|floatformat:0 }}</span>
                    <span class="stat-label">Est. Earnings</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekdays Row -->
    <div class="row mb-4">
        <div class="col-12">
            <h5><i class="fas fa-briefcase me-2"></i>Weekdays</h5>
        </div>
        {% for day in weekdays %}
        <div class="col-lg-20 col-md-4 col-sm-6 day-column">
            <div class="card day-card weekday-card {% if day.is_today %}today-highlight{% endif %}">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <strong>{{ day.date|date:"l" }}</strong>
                        <small class="d-block">{{ day.date|date:"M j" }}</small>
                    </h6>
                </div>
                <div class="card-body">
                    {% if day.entries %}
                        {% for entry in day.entries %}
                        <div class="time-entry">
                            <div class="job-name">{{ entry.job.name }}</div>
                            <div class="time-details">
                                {{ entry.start_time|time:"g:i A" }} - {{ entry.end_time|time:"g:i A" }}
                                {% if entry.break_duration > 0 %}
                                    <small class="text-muted">({{ entry.break_duration }}min break)</small>
                                {% endif %}
                            </div>
                            <div class="duration">{{ entry.total_hours|floatformat:1 }}h</div>
                        </div>
                        {% endfor %}
                        <div class="mt-2 pt-2 border-top">
                            <strong class="text-success">Day Total: {{ day.total_hours|floatformat:1 }} hours</strong>
                        </div>
                    {% else %}
                        <div class="no-entries">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <div>No entries</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Weekend Row -->
    <div class="row mb-4">
        <div class="col-12">
            <h5><i class="fas fa-home me-2"></i>Weekend</h5>
        </div>
        {% for day in weekend %}
        <div class="col-lg-6 col-md-6 day-column">
            <div class="card day-card weekend-card {% if day.is_today %}today-highlight{% endif %}">
                <div class="card-header bg-secondary text-white">
                    <h6 class="card-title mb-0">
                        <strong>{{ day.date|date:"l" }}</strong>
                        <small class="d-block">{{ day.date|date:"M j" }}</small>
                    </h6>
                </div>
                <div class="card-body">
                    {% if day.entries %}
                        {% for entry in day.entries %}
                        <div class="time-entry">
                            <div class="job-name">{{ entry.job.name }}</div>
                            <div class="time-details">
                                {{ entry.start_time|time:"g:i A" }} - {{ entry.end_time|time:"g:i A" }}
                                {% if entry.break_duration > 0 %}
                                    <small class="text-muted">({{ entry.break_duration }}min break)</small>
                                {% endif %}
                            </div>
                            <div class="duration">{{ entry.total_hours|floatformat:1 }}h</div>
                        </div>
                        {% endfor %}
                        <div class="mt-2 pt-2 border-top">
                            <strong class="text-success">Day Total: {{ day.total_hours|floatformat:1 }} hours</strong>
                        </div>
                    {% else %}
                        <div class="no-entries">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <div>No entries</div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Job Summary Table -->
    {% if job_summaries %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Job Summary for This Week
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Job</th>
                            <th>Total Hours</th>
                            <th>Days Worked</th>
                            <th>Avg Hours/Day</th>
                            <th>Est. Earnings</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job_summary in job_summaries %}
                        <tr>
                            <td>
                                <strong>{{ job_summary.job__name }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ job_summary.total_hours|floatformat:1 }}h</span>
                            </td>
                            <td>{{ job_summary.days_count }}</td>
                            <td>{{ job_summary.avg_hours|floatformat:1 }}h</td>
                            <td>
                                <span class="text-success fw-bold">${{ job_summary.estimated_earnings|floatformat:0 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-plus-circle text-success me-2"></i>
                        Add Time Entry
                    </h5>
                    <p class="card-text">Add a new time entry for today or any other day this week.</p>
                    <a href="{% url 'timesheet:entry_create' %}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i> New Entry
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">
                        <i class="fas fa-calendar-day text-info me-2"></i>
                        Daily View
                    </h5>
                    <p class="card-text">Switch to daily view for detailed entry management.</p>
                    <a href="{% url 'timesheet:daily' %}" class="btn btn-info">
                        <i class="fas fa-calendar-day me-1"></i> Daily View
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Add tooltips to time entries
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Highlight current week in navigation
    $('.btn-primary').addClass('active');
});
</script>
{% endblock %}
