# ğŸš€ FamilyHub Makefile - Linux/Mac Version
# Author: FamilyHub Team  
# Date: August 29, 2025
# Version: 1.0.0

# ===================================================================
# ğŸ¯ QUICK REFERENCE
# ===================================================================
# make help          - Show all available commands
# make dev           - Start development environment  
# make prod          - Start production environment
# make quick         - Start quick PostgreSQL setup (5 minutes)
# make build         - Rebuild all containers
# make migrate       - Run Django migrations
# make shell         - Open Django shell
# make dbshell       - Open PostgreSQL shell
# make test          - Run tests
# make backup        - Backup database
# make restore       - Restore database
# make logs          - View logs
# make stop          - Stop all containers
# ===================================================================

# Shell and colors for Linux/Mac
SHELL := /bin/bash
.SHELLFLAGS := -c

# Colors for output
CYAN = \033[0;36m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
BLUE = \033[0;34m
NC = \033[0m # No Color

# Project configuration
PROJECT_NAME = familyhub
COMPOSE_DEV = docker-compose -f docker-compose.dev.yml
COMPOSE_PROD = docker-compose -f docker-compose.production.yml
COMPOSE_QUICK = docker-compose -f docker-compose.quick.yml --env-file .env.quick
DJANGO_SERVICE = django
POSTGRES_SERVICE = postgres-dev
BACKUP_DIR = backups
TIMESTAMP = $(shell date +%Y%m%d_%H%M%S)

# Default target
.DEFAULT_GOAL := help

# ===================================================================
# ğŸ“‹ HELP & INFORMATION
# ===================================================================

.PHONY: help
help: ## ğŸ“‹ Show this help message
	@echo -e "$(CYAN)ğŸš€ FamilyHub Development Workflow Commands$(NC)"
	@echo -e "$(CYAN)===========================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸš€ Quick Start:$(NC)"
	@echo "  make quick         âš¡ Start quick PostgreSQL setup (5 minutes)"
	@echo "  make dev           ğŸ—ï¸  Start development environment"
	@echo "  make prod          ğŸ­ Start production environment"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ Development:$(NC)"
	@echo "  make build         ğŸ”¨ Rebuild all containers"
	@echo "  make migrate       ğŸ“Š Run Django migrations"
	@echo "  make shell         ğŸ Open Django shell"
	@echo "  make dbshell       ğŸ˜ Open PostgreSQL shell"
	@echo "  make test          ğŸ§ª Run tests"
	@echo ""
	@echo -e "$(BLUE)ğŸ“Š Database:$(NC)"
	@echo "  make backup        ğŸ’¾ Backup database"
	@echo "  make restore       ğŸ“¥ Restore database from backup"
	@echo "  make reset-db      ğŸ—‘ï¸  Reset database (WARNING: Deletes all data)"
	@echo ""
	@echo -e "$(BLUE)ğŸ” Monitoring:$(NC)"
	@echo "  make logs          ğŸ“‹ View all service logs"
	@echo "  make logs-django   ğŸ“‹ View Django logs only"
	@echo "  make logs-postgres ğŸ“‹ View PostgreSQL logs only"
	@echo "  make status        ğŸ“Š Show service status"
	@echo ""
	@echo -e "$(BLUE)ğŸ›‘ Control:$(NC)"
	@echo "  make stop          ğŸ›‘ Stop all containers"
	@echo "  make restart       ğŸ”„ Restart all services"
	@echo "  make clean         ğŸ§¹ Clean up containers and volumes"
	@echo ""
	@echo -e "$(BLUE)ğŸ”§ Utilities:$(NC)"
	@echo "  make health        ğŸ’š Check application health"
	@echo "  make setup         ğŸ¯ Initial project setup"
	@echo "  make update        ğŸ“¦ Update dependencies"

# ===================================================================
# ğŸš€ ENVIRONMENT STARTUP
# ===================================================================

.PHONY: quick
quick: ## âš¡ Start quick PostgreSQL setup (5 minutes)
	@echo -e "$(CYAN)âš¡ Starting Quick PostgreSQL Environment...$(NC)"
	@if [ -f "quick-postgres-setup.sh" ]; then \
		chmod +x quick-postgres-setup.sh && ./quick-postgres-setup.sh; \
	else \
		$(COMPOSE_QUICK) up -d; \
		sleep 10; \
		echo -e "$(GREEN)âœ… Quick PostgreSQL environment started!$(NC)"; \
		echo -e "$(BLUE)ğŸŒ pgAdmin: http://localhost:5050$(NC)"; \
		echo -e "$(BLUE)ğŸ˜ PostgreSQL: localhost:5432$(NC)"; \
	fi

.PHONY: dev
dev: ## ğŸ—ï¸ Start development environment
	@echo -e "$(CYAN)ğŸ—ï¸ Starting Development Environment...$(NC)"
	@if [ -f "docker-compose.dev.yml" ]; then \
		$(COMPOSE_DEV) up -d; \
		sleep 15; \
		echo -e "$(GREEN)âœ… Development environment started!$(NC)"; \
		echo -e "$(BLUE)ğŸŒ Django: http://localhost:8000$(NC)"; \
		echo -e "$(BLUE)ğŸ“Š pgAdmin: http://localhost:5050$(NC)"; \
	else \
		echo -e "$(RED)âŒ docker-compose.dev.yml not found$(NC)"; \
		echo -e "$(YELLOW)ğŸ’¡ Use 'make quick' for immediate PostgreSQL setup$(NC)"; \
	fi

.PHONY: prod
prod: ## ğŸ­ Start production environment
	@echo -e "$(CYAN)ğŸ­ Starting Production Environment...$(NC)"
	@if [ -f "docker-compose.production.yml" ]; then \
		$(COMPOSE_PROD) up -d; \
		sleep 30; \
		echo -e "$(GREEN)âœ… Production environment started!$(NC)"; \
		echo -e "$(BLUE)ğŸŒ Application: https://localhost$(NC)"; \
		echo -e "$(BLUE)ğŸ“Š Monitoring: Check 'make logs' for status$(NC)"; \
	else \
		echo -e "$(RED)âŒ docker-compose.production.yml not found$(NC)"; \
		echo -e "$(YELLOW)ğŸ’¡ Use 'make quick' for immediate PostgreSQL setup$(NC)"; \
	fi

# ===================================================================
# ğŸ”§ DEVELOPMENT COMMANDS
# ===================================================================

.PHONY: build
build: ## ğŸ”¨ Rebuild all containers
	@echo -e "$(CYAN)ğŸ”¨ Rebuilding All Containers...$(NC)"
	@if [ -f "docker-compose.dev.yml" ]; then \
		$(COMPOSE_DEV) build --no-cache; \
		echo -e "$(GREEN)âœ… Development containers rebuilt!$(NC)"; \
	fi
	@if [ -f "docker-compose.production.yml" ]; then \
		$(COMPOSE_PROD) build --no-cache; \
		echo -e "$(GREEN)âœ… Production containers rebuilt!$(NC)"; \
	fi
	@$(COMPOSE_QUICK) build --no-cache
	@echo -e "$(GREEN)âœ… All containers rebuilt successfully!$(NC)"

.PHONY: migrate
migrate: ## ğŸ“Š Run Django migrations
	@echo -e "$(CYAN)ğŸ“Š Running Django Migrations...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*django") -gt 0 ]; then \
		docker-compose exec $(DJANGO_SERVICE) python manage.py makemigrations; \
		docker-compose exec $(DJANGO_SERVICE) python manage.py migrate; \
		echo -e "$(GREEN)âœ… Migrations completed!$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  Django container not running. Starting quick environment...$(NC)"; \
		$(MAKE) quick; \
		sleep 10; \
		cd FamilyHub; \
		python manage.py makemigrations; \
		python manage.py migrate; \
		echo -e "$(GREEN)âœ… Migrations completed locally!$(NC)"; \
	fi

.PHONY: shell
shell: ## ğŸ Open Django shell
	@echo -e "$(CYAN)ğŸ Opening Django Shell...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*django") -gt 0 ]; then \
		docker-compose exec $(DJANGO_SERVICE) python manage.py shell; \
	else \
		echo -e "$(YELLOW)âš ï¸  Django container not running. Using local environment...$(NC)"; \
		cd FamilyHub && python manage.py shell; \
	fi

.PHONY: dbshell
dbshell: ## ğŸ˜ Open PostgreSQL shell
	@echo -e "$(CYAN)ğŸ˜ Opening PostgreSQL Shell...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
		$(COMPOSE_QUICK) exec $(POSTGRES_SERVICE) psql -U django -d familyhub; \
	else \
		echo -e "$(YELLOW)âš ï¸  PostgreSQL container not running. Starting quick environment...$(NC)"; \
		$(MAKE) quick; \
		sleep 10; \
		$(COMPOSE_QUICK) exec $(POSTGRES_SERVICE) psql -U django -d familyhub; \
	fi

.PHONY: test
test: ## ğŸ§ª Run tests
	@echo -e "$(CYAN)ğŸ§ª Running Tests...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*django") -gt 0 ]; then \
		docker-compose exec $(DJANGO_SERVICE) python manage.py test; \
	else \
		echo -e "$(YELLOW)âš ï¸  Django container not running. Running tests locally...$(NC)"; \
		cd FamilyHub && python manage.py test; \
	fi
	@echo -e "$(GREEN)âœ… Tests completed!$(NC)"

# ===================================================================
# ğŸ“Š DATABASE MANAGEMENT
# ===================================================================

.PHONY: backup
backup: ## ğŸ’¾ Backup database
	@echo -e "$(CYAN)ğŸ’¾ Creating Database Backup...$(NC)"
	@mkdir -p $(BACKUP_DIR)
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
		docker-compose exec -T $(POSTGRES_SERVICE) pg_dump -U django -d familyhub > "$(BACKUP_DIR)/backup_$(TIMESTAMP).sql"; \
		echo -e "$(GREEN)âœ… Database backup created: $(BACKUP_DIR)/backup_$(TIMESTAMP).sql$(NC)"; \
	else \
		echo -e "$(RED)âŒ PostgreSQL container not running$(NC)"; \
		echo -e "$(YELLOW)ğŸ’¡ Start environment first: make quick$(NC)"; \
	fi

.PHONY: restore
restore: ## ğŸ“¥ Restore database from backup
	@echo -e "$(CYAN)ğŸ“¥ Restoring Database from Backup...$(NC)"
	@if [ ! -d "$(BACKUP_DIR)" ]; then \
		echo -e "$(RED)âŒ Backup directory not found$(NC)"; \
		exit 1; \
	fi
	@LATEST=$$(ls -t $(BACKUP_DIR)/*.sql 2>/dev/null | head -1); \
	if [ -n "$$LATEST" ]; then \
		echo -e "$(YELLOW)ğŸ“‚ Using latest backup: $$(basename $$LATEST)$(NC)"; \
		if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
			cat "$$LATEST" | docker-compose exec -T $(POSTGRES_SERVICE) psql -U django -d familyhub; \
			echo -e "$(GREEN)âœ… Database restored from: $$(basename $$LATEST)$(NC)"; \
		else \
			echo -e "$(RED)âŒ PostgreSQL container not running$(NC)"; \
		fi; \
	else \
		echo -e "$(RED)âŒ No backup files found in $(BACKUP_DIR)$(NC)"; \
	fi

.PHONY: reset-db
reset-db: ## ğŸ—‘ï¸ Reset database (WARNING: Deletes all data)
	@echo -e "$(RED)âš ï¸  WARNING: This will delete ALL database data!$(NC)"
	@read -p "Type 'YES' to confirm database reset: " confirm; \
	if [ "$$confirm" = "YES" ]; then \
		echo -e "$(CYAN)ğŸ—‘ï¸  Resetting Database...$(NC)"; \
		$(COMPOSE_QUICK) down -v; \
		$(COMPOSE_QUICK) up -d; \
		sleep 15; \
		$(MAKE) migrate; \
		echo -e "$(GREEN)âœ… Database reset completed!$(NC)"; \
	else \
		echo -e "$(YELLOW)âŒ Database reset cancelled$(NC)"; \
	fi

# ===================================================================
# ğŸ” MONITORING & LOGS
# ===================================================================

.PHONY: logs
logs: ## ğŸ“‹ View all service logs
	@echo -e "$(CYAN)ğŸ“‹ Viewing All Service Logs...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME)") -gt 0 ]; then \
		docker-compose logs -f; \
	else \
		echo -e "$(YELLOW)âš ï¸  No containers running$(NC)"; \
		echo -e "$(BLUE)ğŸ’¡ Start environment: make quick | make dev | make prod$(NC)"; \
	fi

.PHONY: logs-django
logs-django: ## ğŸ“‹ View Django logs only
	@echo -e "$(CYAN)ğŸ“‹ Viewing Django Logs...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*django") -gt 0 ]; then \
		docker-compose logs -f $(DJANGO_SERVICE); \
	else \
		echo -e "$(YELLOW)âš ï¸  Django container not running$(NC)"; \
	fi

.PHONY: logs-postgres
logs-postgres: ## ğŸ“‹ View PostgreSQL logs only
	@echo -e "$(CYAN)ğŸ“‹ Viewing PostgreSQL Logs...$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
		$(COMPOSE_QUICK) logs -f $(POSTGRES_SERVICE); \
	else \
		echo -e "$(YELLOW)âš ï¸  PostgreSQL container not running$(NC)"; \
	fi

.PHONY: status
status: ## ğŸ“Š Show service status
	@echo -e "$(CYAN)ğŸ“Š Service Status:$(NC)"
	@echo -e "$(CYAN)==================$(NC)"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=$(PROJECT_NAME)"
	@echo ""
	@echo -e "$(BLUE)ğŸ˜ PostgreSQL Connection Test:$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
		if $(COMPOSE_QUICK) exec -T $(POSTGRES_SERVICE) pg_isready -U django -d familyhub >/dev/null 2>&1; then \
			echo -e "$(GREEN)âœ… PostgreSQL: Connected$(NC)"; \
		else \
			echo -e "$(RED)âŒ PostgreSQL: Connection failed$(NC)"; \
		fi; \
	else \
		echo -e "$(YELLOW)âš ï¸  PostgreSQL: Not running$(NC)"; \
	fi

# ===================================================================
# ğŸ›‘ CONTROL COMMANDS
# ===================================================================

.PHONY: stop
stop: ## ğŸ›‘ Stop all containers
	@echo -e "$(CYAN)ğŸ›‘ Stopping All Containers...$(NC)"
	@if [ -f "docker-compose.dev.yml" ]; then $(COMPOSE_DEV) down >/dev/null 2>&1; fi
	@if [ -f "docker-compose.production.yml" ]; then $(COMPOSE_PROD) down >/dev/null 2>&1; fi
	@$(COMPOSE_QUICK) down >/dev/null 2>&1
	@echo -e "$(GREEN)âœ… All containers stopped!$(NC)"

.PHONY: restart
restart: ## ğŸ”„ Restart all services
	@echo -e "$(CYAN)ğŸ”„ Restarting All Services...$(NC)"
	@$(MAKE) stop
	@sleep 5
	@$(MAKE) quick
	@echo -e "$(GREEN)âœ… Services restarted!$(NC)"

.PHONY: clean
clean: ## ğŸ§¹ Clean up containers and volumes
	@echo -e "$(RED)ğŸ§¹ Cleaning Up Containers and Volumes...$(NC)"
	@read -p "This will remove all containers and volumes. Type 'YES' to confirm: " confirm; \
	if [ "$$confirm" = "YES" ]; then \
		docker-compose down -v --remove-orphans; \
		docker system prune -f; \
		echo -e "$(GREEN)âœ… Cleanup completed!$(NC)"; \
	else \
		echo -e "$(YELLOW)âŒ Cleanup cancelled$(NC)"; \
	fi

# ===================================================================
# ğŸ”§ UTILITY COMMANDS
# ===================================================================

.PHONY: health
health: ## ğŸ’š Check application health
	@echo -e "$(CYAN)ğŸ’š Checking Application Health...$(NC)"
	@echo -e "$(CYAN)==================================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸ˜ PostgreSQL Health:$(NC)"
	@if [ $$(docker ps --format "{{.Names}}" | grep -c "$(PROJECT_NAME).*postgres") -gt 0 ]; then \
		if $(COMPOSE_QUICK) exec -T $(POSTGRES_SERVICE) pg_isready -U django -d familyhub >/dev/null 2>&1; then \
			echo -e "$(GREEN)âœ… PostgreSQL: Healthy$(NC)"; \
		else \
			echo -e "$(RED)âŒ PostgreSQL: Unhealthy$(NC)"; \
		fi; \
	else \
		echo -e "$(YELLOW)âš ï¸  PostgreSQL: Not running$(NC)"; \
	fi
	@echo ""
	@echo -e "$(BLUE)ğŸŒ Web Services:$(NC)"
	@if curl -s http://localhost:5050 >/dev/null 2>&1; then \
		echo -e "$(GREEN)âœ… pgAdmin: Healthy (http://localhost:5050)$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  pgAdmin: Not accessible$(NC)"; \
	fi
	@if curl -s http://localhost:8000 >/dev/null 2>&1; then \
		echo -e "$(GREEN)âœ… Django: Healthy (http://localhost:8000)$(NC)"; \
	else \
		echo -e "$(YELLOW)âš ï¸  Django: Not accessible$(NC)"; \
	fi

.PHONY: setup
setup: ## ğŸ¯ Initial project setup
	@echo -e "$(CYAN)ğŸ¯ Setting Up FamilyHub Project...$(NC)"
	@echo -e "$(CYAN)==================================$(NC)"
	@echo -e "$(BLUE)ğŸ“‹ Checking Prerequisites...$(NC)"
	@if ! command -v docker &> /dev/null; then \
		echo -e "$(RED)âŒ Docker not found. Please install Docker first.$(NC)"; \
		exit 1; \
	fi
	@if ! command -v docker-compose &> /dev/null; then \
		echo -e "$(RED)âŒ Docker Compose not found. Please install Docker Compose first.$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)âœ… Prerequisites check passed!$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸš€ Starting Quick PostgreSQL Environment...$(NC)"
	@$(MAKE) quick
	@echo ""
	@echo -e "$(BLUE)ğŸ“Š Running Initial Migrations...$(NC)"
	@$(MAKE) migrate
	@echo ""
	@echo -e "$(GREEN)ğŸ‰ FamilyHub setup completed!$(NC)"
	@echo -e "$(CYAN)ğŸŒ Access pgAdmin: http://localhost:5050$(NC)"
	@echo -e "$(CYAN)ğŸ˜ PostgreSQL: localhost:5432$(NC)"

.PHONY: update
update: ## ğŸ“¦ Update dependencies
	@echo -e "$(CYAN)ğŸ“¦ Updating Dependencies...$(NC)"
	@$(MAKE) build
	@if [ -f "requirements/development.txt" ]; then \
		cd FamilyHub && pip install -r ../requirements/development.txt; \
		echo -e "$(GREEN)âœ… Dependencies updated!$(NC)"; \
	fi

# ===================================================================
# ğŸ¯ DEVELOPMENT SHORTCUTS
# ===================================================================

.PHONY: quick-dev
quick-dev: quick migrate ## âš¡ Quick development setup (PostgreSQL + migrations)
	@echo -e "$(GREEN)ğŸ‰ Quick development environment ready!$(NC)"
	@echo -e "$(BLUE)ğŸŒ pgAdmin: http://localhost:5050$(NC)"
	@echo -e "$(BLUE)ğŸ˜ PostgreSQL: localhost:5432$(NC)"
	@echo -e "$(BLUE)ğŸ”— DATABASE_URL: postgresql://django:secretpass@localhost:5432/familyhub$(NC)"

.PHONY: fresh-start
fresh-start: clean setup ## ğŸ”„ Fresh project start (clean + setup)
	@echo -e "$(GREEN)ğŸ‰ Fresh FamilyHub environment ready!$(NC)"

.PHONY: dev-tools
dev-tools: ## ğŸ› ï¸ Show development tools and URLs
	@echo -e "$(CYAN)ğŸ› ï¸  FamilyHub Development Tools$(NC)"
	@echo -e "$(CYAN)==============================$(NC)"
	@echo ""
	@echo -e "$(BLUE)ğŸŒ Web Interfaces:$(NC)"
	@echo "  pgAdmin:      http://localhost:5050"
	@echo "  Django:       http://localhost:8000"
	@echo "  Production:   https://localhost"
	@echo ""
	@echo -e "$(BLUE)ğŸ”— Database Connection:$(NC)"
	@echo "  Host:         localhost"
	@echo "  Port:         5432"
	@echo "  Database:     familyhub"
	@echo "  Username:     django"
	@echo "  Password:     secretpass"
	@echo "  URL:          postgresql://django:secretpass@localhost:5432/familyhub"
	@echo ""
	@echo -e "$(BLUE)ğŸ˜ pgAdmin Access:$(NC)"
	@echo "  Email:        admin@familyhub.local"
	@echo "  Password:     admin123"
